image: golang:latest

stages:
  - build
  - test

variables:
  GO_PROJECT: gitlab.informatika.org/if3250-k01-g07/assesment-system/icando-ae-api

services:
  - name: postgres:14
    alias: test_database
    command: ["postgres", "-c", "listen_addresses=*"]
    ports:
      - "8006:5432"
    environment:
      POSTGRES_DB: ${TEST_DB_NAME}
      POSTGRES_USER: ${TEST_DB_USERNAME}
      POSTGRES_PASSWORD: ${TEST_DB_PASSWORD}

before_script:
  - mkdir -p $GOPATH/src/$(dirname $GO_PROJECT)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$GO_PROJECT
  - cd $GOPATH/src/$GO_PROJECT/icando-ae-api

build:
  stage: build
  script:
    - go build -o ./main ./cmd/server/server.go
  artifacts:
    paths:
      - ./icando-ae-api/main

test:
  stage: test
  script:
    - go test -v ./...
